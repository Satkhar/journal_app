# Server Sync Plan (PoC)

## Цель
Поднять серверное хранилище на базе `libsql/sqld` и реализовать синхронизацию с локальной базой по кнопке, без ломки текущего UI и доменной модели.

## Решение
- Сервер: `libsql/sqld`.
- Локально: текущий SQLite.
- Синхронизация: вручную по кнопке.
- Формат данных: сохранить текущий (`name`, `date`, `is_checked`) для минимальной миграции.

## Шаги PoC
1. Поднять `sqld` локально и проверить, что сервер принимает SQL-запросы.
2. Создать на сервере схему, эквивалентную локальной таблице.
3. Сохранить текущий контракт моделей (`AttendanceRecord`, `MonthSnapshot`).
4. Реализовать два storage-слоя:
   - `JournalLocalStorage` (текущий SQLite),
   - `JournalRemoteStorage` (сервер libsql).
5. Добавить `SyncService` с операциями:
   - `pull`: сервер -> локальная БД,
   - `push`: локальная БД -> сервер.
6. Для PoC использовать стратегию полной перезаписи месяца:
   - `pull`: серверный месяц перезаписывает локальный,
   - `push`: локальный месяц перезаписывает серверный.
7. Добавить метаданные версии месяца (`month_revision` или `updated_at`) и проверку конфликта перед `push/pull`.
8. Добавить кнопку Sync в UI с понятным статусом:
   - успех,
   - конфликт,
   - ошибка сети/сервера.
9. Протестировать сценарии вручную:
   - локальное изменение -> `push`,
   - серверное изменение -> `pull`,
   - конфликт ревизий -> предупреждение.

## Принципы внедрения
- Не менять UI-слой глубоко: `MainWindow` должен вызывать только use-case/сервис.
- Основные изменения концентрировать вокруг `IJournalStorage` и `SyncService`.
- Делать поэтапно: сначала рабочий PoC, затем дельта-синк и merge-конфликты.

## Что делать после PoC
1. Перейти с полной перезаписи месяца на дельта-синхронизацию.
2. Добавить явную стратегию merge-конфликтов.
3. Добавить auth/token и TLS для серверного доступа.
4. Подготовить резервное копирование и мониторинг.

## Docker
Подробные инструкции по установке Docker и работе с `libsql/sqld` вынесены в отдельный документ:
`doc/docker_setup.md`.
